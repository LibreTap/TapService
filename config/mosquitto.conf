# Mosquitto configuration for LibreTap TapService
# Enables mTLS for secure device authentication

# Persistence
persistence true
persistence_location /mosquitto/data/

# Logging
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_timestamp true

# Connection logging for debugging
connection_messages true

# ====================
# Standard MQTT Listener (internal service-to-broker with mTLS)
# ====================
listener 1883
protocol mqtt

# CA certificate for verifying client certificates
cafile /etc/libretap/ca/ca.crt

# Server certificate and key (broker identity)
certfile /mosquitto/certs/broker.crt
keyfile /mosquitto/certs/broker.key

# Require client certificates for internal connections too (service uses mTLS)
require_certificate true
use_identity_as_username true

# Optional: Allow password fallback for debugging
# To use username/password instead of mTLS, comment out the above require_certificate
# and use_identity_as_username, then uncomment these:
# allow_anonymous false
# password_file /mosquitto/config/passwd
# And also comment out/remove the cafile, certfile, keyfile lines above

# ====================
# TLS/mTLS Listener (for device connections)
# ====================
listener 8883
protocol mqtt

# CA certificate for verifying client certificates
cafile /etc/libretap/ca/ca.crt

# Server certificate and key (broker identity)
# These will be generated by the broker init process
certfile /mosquitto/certs/broker.crt
keyfile /mosquitto/certs/broker.key

# Require client certificates (mTLS)
require_certificate true

# Verify client certificates against CA
use_identity_as_username true

# Certificate Revocation List (optional but recommended)
# crlfile /etc/libretap/ca/crl.pem

# TLS version requirements
tls_version tlsv1.2

# Disable anonymous connections on TLS port
allow_anonymous false
